<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Firebase Notizen v2</title>

<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-100 min-h-screen flex justify-center p-6">

<div class="w-full max-w-xl bg-white rounded-3xl shadow-xl p-8">

<h1 class="text-3xl font-bold text-center mb-6">Meine Notizen</h1>

<p id="status" class="text-center text-slate-600 mb-4">Lade‚Ä¶</p>

<div class="flex justify-center gap-3 mb-6">
  <button id="login" class="bg-blue-600 text-white px-5 py-2 rounded-xl hidden">
    Mit Google anmelden
  </button>
  <button id="logout" class="bg-red-500 text-white px-5 py-2 rounded-xl hidden">
    Abmelden
  </button>
</div>

<form id="form" class="flex gap-2 mb-6 hidden">
  <input id="text" class="flex-1 border rounded-xl p-3" placeholder="Neue Notiz eingeben‚Ä¶">
  <select id="priority" class="border rounded-xl p-3">
    <option value="niedrig">Niedrig</option>
    <option value="mittel">Mittel</option>
    <option value="hoch">Hoch</option>
  </select>
  <button class="bg-cyan-600 text-white px-4 rounded-xl">+</button>
</form>

<div id="list" class="space-y-3"></div>

</div>

<script type="module">
/* üî• Firebase SDKs (CDN) */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import {
  getAuth,
  GoogleAuthProvider,
  signInWithPopup,
  signOut,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

import {
  getFirestore,
  collection,
  addDoc,
  doc,
  updateDoc,
  deleteDoc,
  onSnapshot,
  serverTimestamp,
  query,
  orderBy
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

/* ‚úÖ DEINE FIREBASE ZUGANGSDATEN */
const firebaseConfig = {
  apiKey: "AIzaSyAy_eDSW5Q9KzZFptsTK5DGthk1ed2Objc",
  authDomain: "notizentest-1bcdc.firebaseapp.com",
  projectId: "notizentest-1bcdc",
  storageBucket: "notizentest-1bcdc.firebasestorage.app",
  messagingSenderId: "570048086764",
  appId: "1:570048086764:web:9137d39d90d16b423a1bc9"
};

/* üöÄ Initialisierung */
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();

/* üß† State */
let unsubscribeNotes = null;

/* üì¶ DOM */
const status = document.getElementById("status");
const loginBtn = document.getElementById("login");
const logoutBtn = document.getElementById("logout");
const form = document.getElementById("form");
const list = document.getElementById("list");
const textInput = document.getElementById("text");
const priorityInput = document.getElementById("priority");

/* üîê Login / Logout */
loginBtn.onclick = () => signInWithPopup(auth, provider);
logoutBtn.onclick = () => signOut(auth);

/* üëÄ Auth State Observer */
onAuthStateChanged(auth, user => {

  // üî• alten Listener immer stoppen
  if (unsubscribeNotes) {
    unsubscribeNotes();
    unsubscribeNotes = null;
  }

  if (!user) {
    status.textContent = "Bitte anmelden";
    loginBtn.classList.remove("hidden");
    logoutBtn.classList.add("hidden");
    form.classList.add("hidden");
    list.innerHTML = "";
    return;
  }

  status.textContent = `Angemeldet als ${user.email}`;
  loginBtn.classList.add("hidden");
  logoutBtn.classList.remove("hidden");
  form.classList.remove("hidden");

  startNotesListener(user.uid);
});

/* üì° Realtime Firestore Listener */
function startNotesListener(uid) {
  const q = query(
    collection(db, `notes/${uid}/userNotes`),
    orderBy("createdAt", "desc")
  );

  unsubscribeNotes = onSnapshot(q, snapshot => {
    list.innerHTML = "";

    if (snapshot.empty) {
      list.innerHTML = "<p class='text-slate-500'>Keine Notizen vorhanden</p>";
      return;
    }

    snapshot.forEach(d => renderNote(d.id, d.data(), uid));
  });
}

/* ‚ûï Neue Notiz */
form.onsubmit = async e => {
  e.preventDefault();

  const text = textInput.value.trim();
  if (!text) return;

  await addDoc(
    collection(db, `notes/${auth.currentUser.uid}/userNotes`),
    {
      text,
      priority: priorityInput.value,
      createdAt: serverTimestamp()
    }
  );

  textInput.value = "";
};

/* üñº Notiz anzeigen */
function renderNote(id, note, uid) {
  const div = document.createElement("div");
  div.className = "p-4 rounded-xl border flex justify-between items-center";

  div.innerHTML = `
    <div>
      <p class="font-semibold">${note.text}</p>
      <p class="text-sm text-slate-500">${note.priority}</p>
    </div>
    <div class="flex gap-2">
      <button data-edit>‚úèÔ∏è</button>
      <button data-del>üóë</button>
    </div>
  `;

  div.onclick = async e => {
    if (e.target.dataset.del !== undefined) {
      await deleteDoc(doc(db, `notes/${uid}/userNotes/${id}`));
    }

    if (e.target.dataset.edit !== undefined) {
      const neu = prompt("Notiz bearbeiten:", note.text);
      if (neu) {
        await updateDoc(
          doc(db, `notes/${uid}/userNotes/${id}`),
          { text: neu }
        );
      }
    }
  };

  list.appendChild(div);
}
</script>

</body>
</html>
