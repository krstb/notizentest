<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Meine Notizen (Sicher)</title>

<script src="https://cdn.tailwindcss.com"></script>

<style>
/* Optionale CSS-Erg√§nzungen f√ºr bessere Lesbarkeit und Look */
.note-priority-hoch { background-color: #fee2e2; color: #dc2626; } /* rot-100 / rot-600 */
.note-priority-mittel { background-color: #fef9c3; color: #ca8a04; } /* gelb-100 / gelb-700 */
.note-priority-niedrig { background-color: #d1fae5; color: #059669; } /* gr√ºn-100 / gr√ºn-600 */
</style>

</head>

<body class="bg-slate-100 min-h-screen flex justify-center p-6">

<div class="w-full max-w-xl bg-white rounded-3xl shadow-xl p-8">

<h1 class="text-3xl font-bold text-center mb-6">Meine Notizen</h1>

<p id="status" class="text-center text-slate-600 mb-4">Lade‚Ä¶</p>

<div class="flex justify-center gap-3 mb-6">
  <button id="login" class="bg-blue-600 text-white px-5 py-2 rounded-xl hidden">
    Mit Google anmelden
  </button>
  <button id="logout" class="bg-red-500 text-white px-5 py-2 rounded-xl hidden">
    Abmelden
  </button>
</div>

<form id="form" class="flex gap-2 mb-6 hidden">
  <input id="text" class="flex-1 border rounded-xl p-3 focus:outline-none focus:ring-2 focus:ring-cyan-500" placeholder="Neue Notiz eingeben‚Ä¶" required>
  <select id="priority" class="border rounded-xl p-3 focus:outline-none focus:ring-2 focus:ring-cyan-500">
    <option value="niedrig">Niedrig</option>
    <option value="mittel">Mittel</option>
    <option value="hoch">Hoch</option>
  </select>
  <button type="submit" class="bg-cyan-600 text-white px-4 rounded-xl hover:bg-cyan-700 transition">+</button>
</form>

<div id="list" class="space-y-3"></div>

</div>

<script type="module">
/* üî• Firebase SDKs (CDN) */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import {
  getAuth,
  GoogleAuthProvider,
  signInWithPopup,
  signOut,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

import {
  getFirestore,
  collection,
  addDoc,
  doc,
  updateDoc,
  deleteDoc,
  onSnapshot,
  serverTimestamp,
  query,
  orderBy
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

/* ‚úÖ DEINE FIREBASE ZUGANGSDATEN (bitte pr√ºfen und ggf. ersetzen) */
const firebaseConfig = {
  apiKey: "AIzaSyAy_eDSW5Q9KzZFptsTK5DGthk1ed2Objc",
  authDomain: "notizentest-1bcdc.firebaseapp.com",
  projectId: "notizentest-1bcdc",
  storageBucket: "notizentest-1bcdc.firebasestorage.app",
  messagingSenderId: "570048086764",
  appId: "1:570048086764:web:9137d39d90d16b423a1bc9"
};

/* üöÄ Initialisierung */
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();

/* üß† State */
let unsubscribeNotes = null;

/* üì¶ DOM */
const status = document.getElementById("status");
const loginBtn = document.getElementById("login");
const logoutBtn = document.getElementById("logout");
const form = document.getElementById("form");
const list = document.getElementById("list");
const textInput = document.getElementById("text");
const priorityInput = document.getElementById("priority");

/* üîê Login / Logout */
loginBtn.onclick = () => signInWithPopup(auth, provider);
logoutBtn.onclick = () => signOut(auth);

/* üëÄ Auth State Observer */
onAuthStateChanged(auth, user => {

  // üî• Alten Listener stoppen, falls er l√§uft
  if (unsubscribeNotes) {
    unsubscribeNotes();
    unsubscribeNotes = null;
  }

  if (!user) {
    status.textContent = "Bitte anmelden";
    loginBtn.classList.remove("hidden");
    logoutBtn.classList.add("hidden");
    form.classList.add("hidden");
    list.innerHTML = "";
    return;
  }

  status.textContent = `Angemeldet als ${user.email}`;
  loginBtn.classList.add("hidden");
  logoutBtn.classList.remove("hidden");
  form.classList.remove("hidden");

  // Listener f√ºr Notizen starten, die nur der aktuellen UID geh√∂ren
  startNotesListener(user.uid);
});

/* üì° Realtime Firestore Listener */
function startNotesListener(uid) {
  list.innerHTML = "<p class='text-slate-500'>Notizen werden geladen...</p>";
  
  // Abfrage, die nach Priorit√§t und dann nach Erstellungsdatum sortiert
  const q = query(
    collection(db, `notes/${uid}/userNotes`),
    orderBy("priority", "desc"), 
    orderBy("createdAt", "desc")
  );

  unsubscribeNotes = onSnapshot(q, snapshot => {
    list.innerHTML = "";
    
    if (snapshot.empty) {
      list.innerHTML = "<p class='text-slate-500'>Keine Notizen vorhanden</p>";
      return;
    }

    // Rendert die Notizen nur, wenn die Abfrage erfolgreich war
    snapshot.forEach(d => renderNote(d.id, d.data(), uid));
    status.textContent = `Angemeldet als ${auth.currentUser.email}`; 
  }, (error) => {
      // WICHTIG: F√§ngt Fehler ab (z.B. fehlende Indexe) und gibt einen Hinweis
      console.error("Fehler beim Laden der Notizen:", error);
      list.innerHTML = `<p class='text-red-600 font-semibold'>Ladefehler: Bitte pr√ºfen Sie die Firebase Console (F12).</p>`;
      if (error.code === 'failed-precondition') {
          // Hinweis, wenn der Index fehlt
          status.textContent = "Fehler: Index fehlt! Bitte Index erstellen (siehe Anleitung).";
      } else if (error.code === 'permission-denied') {
          // Hinweis, wenn die Sicherheitsregeln falsch sind
          status.textContent = "Fehler: Zugriff verweigert! Bitte Sicherheitsregeln pr√ºfen.";
      }
  });
}

/* ‚ûï Neue Notiz */
form.onsubmit = async e => {
  e.preventDefault();

  const text = textInput.value.trim();
  if (!text) return;
  
  // F√ºgt die Notiz unter dem privaten Pfad des angemeldeten Benutzers hinzu
  await addDoc(
    collection(db, `notes/${auth.currentUser.uid}/userNotes`),
    {
      text,
      priority: priorityInput.value,
      createdAt: serverTimestamp()
    }
  );

  textInput.value = "";
  priorityInput.value = "niedrig";
};

/* üñº Notiz anzeigen */
function renderNote(id, note, uid) {
  const div = document.createElement("div");
  // Verbessertes Styling der Notizen-Elemente
  div.className = "p-4 rounded-xl shadow-md border border-slate-200 flex justify-between items-start transition-all hover:shadow-lg";

  // Klassen f√ºr Priorit√§ts-Farbgebung
  const priorityClass = `note-priority-${note.priority}`;

  div.innerHTML = `
    <div>
      <p class="font-semibold text-slate-800">${note.text}</p>
      <span class="text-xs font-medium px-2 py-0.5 rounded ${priorityClass}">
        ${note.priority.charAt(0).toUpperCase() + note.priority.slice(1)}
      </span>
    </div>
    <div class="flex gap-3 text-xl mt-1">
      <button data-edit class="hover:text-cyan-600 transition">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L15.232 5.232z" /></svg>
      </button>
      <button data-del class="hover:text-red-500 transition">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
      </button>
    </div>
  `;

  div.onclick = async e => {
    if (e.target.dataset.del !== undefined) {
      if(confirm("Sicher l√∂schen?")) {
          await deleteDoc(doc(db, `notes/${uid}/userNotes/${id}`));
      }
    }

    if (e.target.dataset.edit !== undefined) {
      const neu = prompt("Notiz bearbeiten:", note.text);
      if (neu !== null && neu.trim() !== "") { // Pr√ºft auf Abbrechen und leeren String
        await updateDoc(
          doc(db, `notes/${uid}/userNotes/${id}`),
          { text: neu.trim() }
        );
      }
    }
  };

  list.appendChild(div);
}
</script>

</body>
</html>